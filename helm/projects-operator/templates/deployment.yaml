apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
{{ include "projects-operator.labels" . | indent 4 }}
  name: {{ template "projects-operator.fullname" . }}
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: {{ include "projects-operator.name" . }}
      app.kubernetes.io/instance: {{ .Release.Name }}
  template:
    metadata:
      labels:
        app.kubernetes.io/name: {{ include "projects-operator.name" . }}
        app.kubernetes.io/instance: {{ .Release.Name }}
    spec:
      imagePullSecrets:
{{ toYaml .Values.imagePullSecrets | indent 8 }}
      containers:
        - args:
            - --secure-listen-address=0.0.0.0:8443
            - --upstream=http://127.0.0.1:8080/
            - --logtostderr=true
            - --v=10
          image: "{{ .Values.kubeRbacProxy.image }}"
          name: kube-rbac-proxy
          ports:
            - containerPort: 8443
              name: https
        - args:
            - --metrics-addr=127.0.0.1:8080
            - --enable-leader-election
          command:
            - /manager
          env:
            - name: ROLE_1_APIGROUPS
              value: {{ .Values.role1.apiGroups }}
            - name: ROLE_1_RESOURCES
              value: {{ .Values.role1.resources }}
            - name: ROLE_1_VERBS
              value: "{{ .Values.role1.verbs }}"
            - name: ROLE_2_APIGROUPS
              value: {{ .Values.role2.apiGroups }}
            - name: ROLE_2_RESOURCES
              value: {{ .Values.role2.resources }}
            - name: ROLE_2_VERBS
              value: "{{ .Values.role2.verbs }}"
            - name: ROLE_3_APIGROUPS
              value: {{ .Values.role3.apiGroups }}
            - name: ROLE_3_RESOURCES
              value: {{ .Values.role3.resources }}
            - name: ROLE_3_VERBS
              value: "{{ .Values.role3.verbs }}"
          image: "{{ .Values.image }}"
          imagePullPolicy: {{ .Values.imagePullPolicy }}
          name: manager
          resources:
{{ toYaml .Values.resources | indent 12 }}
            {{- with .Values.nodeSelector }}
      nodeSelector:
            {{ toYaml . | indent 8 }}
            {{- end }}
            {{- with .Values.affinity }}
      affinity:
            {{ toYaml . | indent 8 }}
            {{- end }}
            {{- with .Values.tolerations }}
      tolerations:
            {{ toYaml . | indent 8 }}
            {{- end }}
      terminationGracePeriodSeconds: 10
